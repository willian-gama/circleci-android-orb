description: Deploy the app to Google Play internal testing.

executor:
  name: android_executor
  resource_class: large

parameters:
  app_name:
    type: string
    description: App name to display in Slack notification

steps:
  - load_workspace
  - restore_gradle_cache
  - android/restore-build-cache
  - restore_and_save_gems_cache
  - run:
      name: New version check
      command: bundle exec fastlane update_check
  - run:
      name: Decode base64 keystore
      command: <<include(scripts/decode_keystore.sh)>>
  - run:
      name: Fastlane meta data check
      command: bundle exec fastlane metadata_check
  - run:
      name: Commit auto generate metadata if needed
      command: <<include(scripts/metadata_commit_check.sh)>>
  - run:
      name: Git fetch
      command: git fetch
  - run:
      name: Deploy bundle to playstore
      command: bundle exec fastlane deploy_bundle
  - run:
      name: Create github release
      command: bundle exec fastlane create_github_release
  - run:
      name: Set latest tag for circle message
      command: bundle exec fastlane set_version_tag
  - slack_notify_failure_event
  - run:
      name: Prepare slack notification
      environment:
        APP_NAME: << parameters.app_name >>
      command: <<include(scripts/prepare_slack_notification.sh)>>
  - slack/notify:
      channel: squad-core-mobile
      event: pass
      template: UPLOAD_BUILD_TEMPLATE