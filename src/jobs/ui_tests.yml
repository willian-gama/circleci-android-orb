description: Run ui tests.

parameters:
  resource_class:
    type: enum
    description: Configure the executor resource class
    enum: [medium, large, xlarge]
    default: large

  build_variant:
    type: enum
    description: Define build variant such as debug, fullDebug
    enum: [debug, fullDebug]

  parallelism:
    description: Circleci machines/containers to use for load balancing
    type: integer
    default: 1

executor:
  name: android_executor
  resource_class: << parameters.resource_class >>

parallelism: << parameters.parallelism >>

steps:
  - load_workspace
  - generate_gradle_cache_key
  - restore_gradle_cache
  - android/restore-build-cache
  - android/create-avd:
      avd-name: TestAVD
      install: true
      system-image: system-images;android-33;google_apis;x86_64
      additional-args: --device pixel_3a_xl
  - android/accept-licenses
  - run:
      name: Split ui tests
      command: <<include(scripts/split_ui_tests.sh)>>
  - run:
      name: Prepare assemble ui command
      environment:
        BUILD_VARIANT: << parameters.build_variant >>
      command: <<include(scripts/prepare_ui_assemble_command.sh)>>
  - android/start-emulator:
      avd-name: TestAVD
      no-window: true
      restore-gradle-cache-post-emulator-launch: true
      post-emulator-launch-assemble-command: ./gradlew $UI_ASSEMBLE_COMMAND
  - run:
      name: Run ui tests
      environment:
        BUILD_VARIANT: << parameters.build_variant >>
        MAX_TRIES: 2
        RETRY_INTERVAL: 2
      command: <<include(scripts/run_ui_tests.sh)>>
      no_output_timeout: 5m
  - android/save-build-cache
  - android/save-gradle-cache
  - persist_to_workspace:
      root: ~/
      paths:
        - "src/**/build/outputs/code_coverage"
  - run:
      name: Save ui test results
      command: <<include(scripts/save_ui_tests_results.sh)>>
      when: always
  - store_test_results:
      path: ~/test-results/ui-tests