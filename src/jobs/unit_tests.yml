description: Run unit tests

executor:
  name: android_executor
  resource_class: large

parameters:
  build_variant:
    type: enum
    description: "Define build variant such as: debug, fullDebug"
    enum: ["debug", "fullDebug"]

  parallelism:
    description: Circleci machines/containers to use for load balancing
    type: integer
    default: 1

parallelism: << parameters.parallelism >>

steps:
  - load_workspace
  - generate_gradle_cache_key
  - restore_gradle_cache
  - run:
      name: Split unit tests
      environment:
        BUILD_VARIANT: << parameters.build_variant >>
      command: <<include(scripts/split_unit_tests.sh)>>
  - run:
      name: Run unit tests
      environment:
        BUILD_VARIANT: << parameters.build_variant >>
      command: <<include(scripts/run_unit_tests.sh)>>
  - persist_to_workspace:
      root: ~/
      paths:
        - "src/**/build/outputs/unit_test_code_coverage"
         # Java classes when available
        - "src/**/build/intermediates/javac/debug/classes"
        - "src/**/build/intermediates/javac/*Debug/classes"
         # Kotlin classes when available
        - "src/**/build/tmp/kotlin-classes/debug"
        - "src/**/build/tmp/kotlin-classes/*Debug"
  - run:
      name: Save unit test results
      command: <<include(scripts/save_unit_tests_results.sh)>>
      when: always
  - store_test_results:
      path: ~/test-results/unit-tests