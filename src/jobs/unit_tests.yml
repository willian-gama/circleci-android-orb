description: Run unit tests

executor: android_large_executor

parameters:
  build_variant:
    default: "debug"
    description: Define build variant. e.g. debug, fullDebug
    type: enum
    enum: ["debug", "fullDebug"]

  run_screenshot_tests:
    type: boolean
    description: Determine if screenshot tests should be tested alongside unit tests

steps:
  - load_workspace
  - generate_gradle_cache_key
  - restore_gradle_cache
  - android/restore-build-cache
  - when:
      condition:
        equal: [ true, << pipeline.parameters.run_screenshot_tests >> ]
      steps:
        - run:
            name: Run unit and screenshot tests
            environment:
              BUILD_VARIANT: << parameters.build_variant >>
            command: <<include(scripts/run_screenshot_tests.sh)>>
  - when:
      condition:
        equal: [ false, << pipeline.parameters.run_screenshot_tests >> ]
      steps:
        - run:
            name: Run unit tests
            environment:
              BUILD_VARIANT: << parameters.build_variant >>
            command:  <<include(scripts/run_unit_tests.sh)>>
  - persist_to_workspace:
      root: ~/
      paths: "src/**/build/outputs/unit_test_code_coverage"
  - run:
      name: Save unit test results
      command: <<include(scripts/save_unit_tests_results.sh)>>
      when: always
  - store_test_results:
      path: ~/test-results/unit-tests